<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Flow: Custom Time</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* --- 1. CSS SECTION --- */
        
        :root {
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-main: #2d3748;
            --text-sub: #718096;
            --primary: #4f46e5;
            --primary-glow: rgba(79, 70, 229, 0.3);
            --break: #10b981;
            --knob-color: #ffffff;
            --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        }

        body {
            background: var(--bg-gradient);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
            transition: background 0.5s ease;
        }

        .theme-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            align-items: center;
        }

        .theme-btn {
            width: 30px; 
            height: 30px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.8);
            cursor: pointer;
            padding: 0;
            transition: transform 0.2s;
        }
        .theme-btn:hover { transform: scale(1.2); }

        /* NEW STYLE FOR THE CUSTOM TIME BUTTON */
        .custom-time-btn {
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(0,0,0,0.1);
        }

        .app-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.5);
            position: relative;
        }

        h1 { font-size: 24px; font-weight: 700; margin: 0 0 20px 0; color: var(--text-main); }

        .timer-wrapper { position: relative; width: 260px; height: 260px; margin-bottom: 30px; }
        
        canvas {
            position: absolute; top: 0; left: 0; width: 260px; height: 260px;
            cursor: grab; z-index: 10; touch-action: none;
        }
        canvas:active { cursor: grabbing; }

        .timer-info {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .time-display { font-size: 56px; font-weight: 800; color: var(--text-main); font-variant-numeric: tabular-nums; letter-spacing: -2px; margin: 0; line-height: 1; }
        .status-label { margin-top: 5px; font-size: 14px; color: var(--text-sub); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-bottom: 30px; }

        button { padding: 16px; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.98); }

        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 14px var(--primary-glow); }
                .btn-sec {
            background: #f1f5f9;
            color: #333333 !important; /* Force text to be Dark Grey */
            border: 1px solid rgba(0,0,0,0.1); /* Optional: Adds a subtle border so it pops */
        }
        .btn-sec:hover { background: #e2e8f0; }

        
        .tasks-area { width: 100%; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; background: #f8fafc; padding: 8px; border-radius: 14px; border: 1px solid rgba(0,0,0,0.05); }        /* --- UPDATED INPUT GROUP (FIXES INVISIBLE TEXT) --- */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #f8fafc; /* White Background */
            padding: 8px;
            border-radius: 14px;
            border: 1px solid rgba(0,0,0,0.05);
            transition: border-color 0.2s;
        }

        .input-group:focus-within { border-color: var(--primary); }

        /* FORCE DARK TEXT INSIDE THE WHITE BOX */
        .input-group label, 
        .input-group span, 
        .input-group input {
            color: #333333 !important; /* Always Dark Grey */
        }

        /* Keep the file name slightly lighter, but still visible */
        #fileName {
            color: #666666 !important;
        }

                input { 
            flex: 1; 
            border: none; 
            background: transparent; 
            padding: 8px 12px; 
            font-size: 15px; 
            outline: none; 
            
            /* CHANGED from var(--text-main) to #333333 */
            color: #333333 !important; 
        }

        input { flex: 1; border: none; background: transparent; padding: 8px 12px; font-size: 15px; outline: none; color: var(--text-main); }
        .btn-add { background: var(--primary); color: white; border-radius: 10px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; padding: 0; }
        
        ul { list-style: none; padding: 0; margin: 0; width: 100%; }
                li { 
            display: flex; 
            align-items: center; 
            padding: 12px 16px; 
            background: white; 
            margin-bottom: 10px; 
            border-radius: 12px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); 
            
            /* ADD THIS LINE TO FORCE BLACK TEXT */
            color: #333333 !important; 
        }

        li.done { opacity: 0.5; text-decoration: line-through; }
        .custom-checkbox { width: 20px; height: 20px; border: 2px solid #cbd5e0; border-radius: 6px; margin-right: 12px; cursor: pointer; }
        li.done .custom-checkbox { background: var(--primary); border-color: var(--primary); }
        .delete-btn { background: transparent; color: #ef4444; padding: 5px; margin-left: auto; }

        #alarmModal {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(79, 70, 229, 0.95); z-index: 100; border-radius: 24px;
            flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center;
        }
        .stop-btn { background: white; color: var(--primary); padding: 15px 40px; border-radius: 50px; }
                /* --- FORCE DARK TEXT ON WHITE INPUTS --- */
        
        /* 1. Force the container to handle text correctly */
        .input-group {
            background: #f8fafc !important; /* Ensure background is white */
        }

        /* 2. Force Labels, Spans, and Typed Text to be Dark */
        .input-group label, 
        .input-group span, 
        .input-group input {
            color: #333333 !important; /* Force Dark Grey */
            opacity: 1 !important;     /* Force Visible */
        }

        /* 3. Force the "Ghost Text" (Placeholder) to be Grey */
        /* This is likely why the Task box looked empty! */
        .input-group input::placeholder {
            color: #888888 !important;
            opacity: 1 !important;
        }

        /* 4. Keep the file name distinct */
        #fileName {
            color: #666666 !important;
        }
                .preset-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .preset-btn {
            background: rgba(255,255,255,0.5);
            border: 1px solid rgba(0,0,0,0.05);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            color: #333; /* Dark text for visibility */
            cursor: pointer;
        }
        .preset-btn:hover { background: white; transform: scale(1.05); }
                .ambience-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .ambience-btn {
            background: transparent;
            font-size: 20px;
            border: 2px solid transparent;
            border-radius: 50%;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            opacity: 0.6;
            cursor: pointer;
        }
        .ambience-btn:hover { opacity: 1; background: rgba(255,255,255,0.2); }
        
        /* Active State (When sound is playing) */
        .ambience-btn.active {
            opacity: 1;
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 10px var(--primary-glow);
        }
                .stats-panel {
            width: 100%;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        .stats-panel h3 { font-size: 16px; margin-bottom: 15px; opacity: 0.8; }
        
        .chart-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 100px;
            padding: 0 10px;
        }
        
        .chart-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            flex: 1;
        }
        
        .chart-bar {
            width: 8px;
            background: var(--primary);
            border-radius: 4px;
            transition: height 1s ease;
            opacity: 0.7;
        }
        
        .chart-day {
            font-size: 10px;
            opacity: 0.6;
        }
        
        
    </style>
</head>
<body>

    <div class="app-container">
        <div id="alarmModal">
            <h1 style="color:white">‚è∞ Time's Up!</h1>
            <p style="color:white; margin-bottom: 20px;">Great job staying focused.</p>
            <button class="stop-btn" onclick="stopAlarm()">STOP ALARM</button>
        </div>
                <div class="ambience-row">
            <button class="ambience-btn" onclick="toggleAmbience('rain', this)">‚òÅÔ∏é</button>
            <button class="ambience-btn" onclick="toggleAmbience('cafe', this)">‚òïÔ∏é</button>
            <button class="ambience-btn" onclick="toggleAmbience('fire', this)">‡¶å</button>
        </div>
        
        <audio id="audio-rain" loop src="https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg"></audio>
        <audio id="audio-cafe" loop src="https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg"></audio>
        <audio id="audio-fire" loop src="https://actions.google.com/sounds/v1/ambiences/fireplace.ogg"></audio>
        

        <h1>Pro Flow</h1>
        <button onclick="copyLink()" style="background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.1); padding: 8px 15px; border-radius: 20px; cursor: pointer; margin-bottom: 20px; font-size: 14px; font-weight: bold; color: #333;">
    ‚éò Copy Invite Link
</button>


        <div class="theme-row">
            <button class="theme-btn custom-time-btn" onclick="setCustomTime()" title="Set Exact Time">‚å®</button>
            
            <div style="width: 1px; height: 20px; background: rgba(255,255,255,0.3); margin: 0 5px;"></div>
            
            <button class="theme-btn" onclick="setTheme('light')" title="Light" style="background: #e2e8f0;"></button>
            <button class="theme-btn" onclick="setTheme('night')" title="Night" style="background: #0f172a; border: 1px solid #333;"></button>
            <button class="theme-btn" onclick="setTheme('sunset')" title="Sunset" style="background: linear-gradient(135deg, #667eea, #764ba2);"></button>
            <button class="theme-btn" onclick="setTheme('zen')" title="Zen" style="background: #14532d;"></button>
            <button class="theme-btn" onclick="setTheme('image')" title="Image" style="background-image: url('https://i.imgur.com/lR0svmK.jpeg'); background-size: cover;"></button>
        </div>

        <div class="timer-wrapper">
            <canvas id="timerCanvas"></canvas>
            <div class="timer-info">
                <div class="time-display" id="timeDisplay">25:00</div>
                <div class="status-label" id="statusLabel">Focus</div>
            </div>
        </div>
                <div class="preset-row">
            <button class="preset-btn" onclick="setPreset(25)">25m</button>
            <button class="preset-btn" onclick="setPreset(45)">45m</button>
            <button class="preset-btn" onclick="setPreset(60)">60m</button>
        </div>
        

        <div class="input-group" style="margin-bottom: 20px; align-items: center;">
            <label for="alarmInput" style="flex: 1; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-main);">
                <span>üîî Set Alarm Sound</span>
                <span id="fileName" style="font-size: 12px; opacity: 0.6;">(Default: Beep)</span>
            </label>
            <input type="file" id="alarmInput" accept="audio/*" style="display: none;">
            <audio id="alarmAudio" playsinline></audio>
        </div>

        <div class="controls">
            <button class="btn-primary" id="startBtn" onclick="toggleTimer()">Start Focus</button>
            <button class="btn-sec" id="modeBtn" onclick="switchMode()">Take Break</button>
        </div>

        <div class="tasks-area">
            <div class="input-group">
                <input type="text" id="taskInput" placeholder="What is your goal?" onkeypress="handleEnter(event)">
                <button class="btn-add" onclick="addTask()">Ôºã</button>
            </div>
            <ul id="taskList"></ul>
        </div>
                <div class="stats-panel">
            <h3>Weekly Focus</h3>
            <div class="chart-container" id="weeklyChart">
                </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
    const firebaseConfig = {
  apiKey: "AIzaSyAElvBw5FaYHA7mdnnI2vAQ1LwfUjxd5w0",
  authDomain: "proflow-65bff.firebaseapp.com",
  databaseURL: "https://proflow-65bff-default-rtdb.firebaseio.com",
  projectId: "proflow-65bff",
  storageBucket: "proflow-65bff.firebasestorage.app",
  messagingSenderId: "214355042812",
  appId: "1:214355042812:web:c9b07ce98387dd1ea31279"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    // --- ROOM SETUP ---
    const urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('room');

    if (!roomId) {
        roomId = prompt("Enter a Room Name (e.g. 'study'):") || "default";
        // Update URL so you can copy-paste it to a friend
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + roomId;
        window.history.pushState({path: newUrl}, '', newUrl);
    }
    const roomRef = db.ref('rooms/' + roomId);
    
            let currentAmbience = null;

        function toggleAmbience(type, btn) {
            const audio = document.getElementById('audio-' + type);
            
            // If clicking the same button that is already playing, stop it
            if (currentAmbience === audio && !audio.paused) {
                audio.pause();
                btn.classList.remove('active');
                currentAmbience = null;
                return;
            }

            // Stop any currently playing ambience
            document.querySelectorAll('audio[id^="audio-"]').forEach(a => {
                a.pause();
                a.currentTime = 0;
            });
            document.querySelectorAll('.ambience-btn').forEach(b => b.classList.remove('active'));

            // Play the new one
            audio.volume = 0.5; // 50% volume so it's not too loud
            audio.play();
            btn.classList.add('active');
            currentAmbience = audio;
        }
        
        const themes = {
            light: { '--bg-gradient': 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)', '--card-bg': 'rgba(255, 255, 255, 0.85)', '--text-main': '#2d3748', '--text-sub': '#718096', '--primary': '#4f46e5', '--primary-glow': 'rgba(79, 70, 229, 0.3)', '--knob-color': '#ffffff' },
            night: { '--bg-gradient': '#0f172a', '--card-bg': '#1e293b', '--text-main': '#f8fafc', '--text-sub': '#94a3b8', '--primary': '#38bdf8', '--primary-glow': 'rgba(56, 189, 248, 0.4)', '--knob-color': '#38bdf8' },
            sunset: { '--bg-gradient': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', '--card-bg': 'rgba(255, 255, 255, 0.15)', '--text-main': '#ffffff', '--text-sub': '#e2e8f0', '--primary': '#f472b6', '--primary-glow': 'rgba(244, 114, 182, 0.5)', '--knob-color': '#fcd34d' },
            zen: { '--bg-gradient': '#14532d', '--card-bg': '#fef3c7', '--text-main': '#422006', '--text-sub': '#92400e', '--primary': '#15803d', '--primary-glow': 'rgba(21, 128, 61, 0.3)', '--knob-color': '#15803d' },
            image: { '--bg-gradient': "url('https://i.imgur.com/lR0svmK.jpeg')", '--card-bg': 'rgba(0, 0, 0, 0.6)', '--text-main': '#ffffff', '--text-sub': '#e2e8f0', '--primary': '#fbbf24', '--primary-glow': 'rgba(251, 191, 36, 0.4)', '--knob-color': '#fbbf24' }
        };

        const canvas = document.getElementById('timerCanvas');
        const ctx = canvas.getContext('2d');
        const size = 260;
        const dpr = window.devicePixelRatio || 1;
        canvas.width = size * dpr;
        canvas.height = size * dpr;
        ctx.scale(dpr, dpr);
        canvas.style.width = size + 'px';
        canvas.style.height = size + 'px';

        const maxMinutes = 120;
        const maxSeconds = maxMinutes * 60;
        const silentAudioData = "data:audio/mp3;base64,SUQzBAAAAAABAFRYWFQAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhUAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhUAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIWFhYWNjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2N//////////////////////////////////////////////////////////////////wAAAP9MYXZjNTcuNjQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7UAAAASAAAExAAAAEAAABHqGZgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//7UAAAASAAAExAAAAEAAABHqGZgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";

        let timeLeft = 25 * 60;
        let isRunning = false;
        let isFocusMode = true;
        let timerInterval;
        let isDragging = false;
        let lastPct = 0;

        const timeDisplay = document.getElementById('timeDisplay');
        const startBtn = document.getElementById('startBtn');
        const modeBtn = document.getElementById('modeBtn');
        const statusLabel = document.getElementById('statusLabel');
        const alarmModal = document.getElementById('alarmModal');
        const alarmInput = document.getElementById('alarmInput');
        const alarmAudio = document.getElementById('alarmAudio');
        const fileNameDisplay = document.getElementById('fileName');
        let audioCtx;

        function setTheme(themeName) {
            const selectedTheme = themes[themeName];
            if (!selectedTheme) return;
            for (let variable in selectedTheme) { document.documentElement.style.setProperty(variable, selectedTheme[variable]); }
            localStorage.setItem('proFlowTheme', themeName);
            updateDisplay();
        }
        
        const savedTheme = localStorage.getItem('proFlowTheme') || 'light';
        setTheme(savedTheme);

        // --- NEW: CUSTOM TIME INPUT ---
                function setCustomTime() {
            // 1. Ask for time
            let m = prompt("Enter Minutes (0-120):", "2");
            let s = prompt("Enter Seconds (0-59):", "30");
            
            if (m === null || s === null) return;
            
            m = parseInt(m) || 0;
            s = parseInt(s) || 0;
            
            let total = (m * 60) + s;
            if (total > maxSeconds) total = maxSeconds;

            // 2. TELL THE DATABASE the new time (This fixes the bug!)
            roomRef.update({
                timeLeft: total,
                isRunning: false // Pause if we change time
            });
        }

                        function setPreset(minutes) {
            // Tell the database the new time
            roomRef.update({
                timeLeft: minutes * 60,
                isRunning: false
            });
        }

            function startTimerLocal() {
        // This is the code that actually runs the timer on your screen
        unlockAudio();
        if (!alarmAudio.src) { alarmAudio.src = silentAudioData; }
        alarmAudio.play().catch(() => {});
        
        isRunning = true;
        startBtn.innerText = "Pause";
        startBtn.style.background = "#F59E0B";

        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (timeLeft > 0) {
                timeLeft--;
                updateDisplay();
                // Only update the DB every 5 seconds to save bandwidth
                if (timeLeft % 5 === 0) {
                    roomRef.update({ timeLeft: timeLeft });
                }
            } else {
                completeTimer();
                roomRef.update({ isRunning: false, timeLeft: 0 }); // Tell friend we are done
            }
        }, 1000);
    }

    function pauseTimerLocal() {
        isRunning = false;
        clearInterval(timerInterval);
        startBtn.innerText = isFocusMode ? "Resume Focus" : "Resume Break";
        resetButtonStyle();
    }
    
        

        function drawRing(percentage) {
            ctx.clearRect(0, 0, size, size);
            const centerX = size / 2;
            const centerY = size / 2;
            const radius = 115;
            const lineWidth = 12;

            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(-Math.PI / 2);
            ctx.translate(-centerX, -centerY);

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.lineWidth = lineWidth;
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineCap = 'round';
            ctx.stroke();

            let drawPct = Math.max(0, Math.min(1, percentage));
            if (drawPct > 0) {
                ctx.beginPath();
                const color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.lineCap = 'round';
                ctx.arc(centerX, centerY, radius, 0, (2 * Math.PI) * drawPct);
                ctx.stroke();

                const angle = (2 * Math.PI) * drawPct;
                const knobX = centerX + radius * Math.cos(angle);
                const knobY = centerY + radius * Math.sin(angle);

                ctx.beginPath();
                ctx.arc(knobX, knobY, 14, 0, 2 * Math.PI);
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--knob-color').trim();
                ctx.shadowColor = "rgba(0,0,0,0.2)";
                ctx.shadowBlur = 10;
                ctx.fill();
            } else {
                ctx.beginPath();
                ctx.arc(centerX + radius, centerY, 14, 0, 2 * Math.PI);
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--knob-color').trim();
                ctx.fill();
            }
            ctx.restore();
        }

        function getAngleFromEvent(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const dx = clientX - centerX;
            const dy = clientY - centerY;
            let angle = Math.atan2(dy, dx) + (Math.PI / 2);
            if (angle < 0) angle += Math.PI * 2;
            return angle / (Math.PI * 2);
        }

        function handleDrag(e) {
            if(isRunning) pauseTimer();
            let currentPct = getAngleFromEvent(e);
            
            let diff = currentPct - lastPct;
            if (Math.abs(diff) > 0.5) {
                if (diff < 0) currentPct = 1.0; 
                else currentPct = 0.0;          
            }
            if (currentPct > 0.99) currentPct = 1.0;
            if (currentPct < 0.01) currentPct = 0.0;

            lastPct = currentPct;
            timeLeft = Math.round(currentPct * maxSeconds);
            updateDisplay();
               // Only update DB if we aren't dragging too fast (throttling is better, but this works for now)
   if (!isRunning) {
       roomRef.update({ timeLeft: timeLeft });
   }
   
        }
        

        function startDrag(e) {
            isDragging = true;
            lastPct = timeLeft / maxSeconds; 
            handleDrag(e);
        }

        canvas.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', (e) => { if (isDragging) handleDrag(e); });
        window.addEventListener('mouseup', () => { isDragging = false; });
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrag(e); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { if (isDragging) { e.preventDefault(); handleDrag(e); } }, {passive: false});
        window.addEventListener('touchend', () => { isDragging = false; });
    // --- SYNC LISTENER ---
    // This runs whenever the database changes (e.g., your friend clicks start)
    roomRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            // 1. Sync Time if it's different
            if (data.timeLeft !== undefined && Math.abs(timeLeft - data.timeLeft) > 2) {
                timeLeft = data.timeLeft;
                updateDisplay();
            }
            // 2. Sync Start/Stop
            if (data.isRunning !== undefined) {
                if (data.isRunning && !isRunning) {
                    startTimerLocal(); // We will create this specific function next
                } else if (!data.isRunning && isRunning) {
                    pauseTimerLocal(); // We will create this specific function next
                }
            }
            // 3. Sync Mode (Focus/Break)
            if (data.mode && data.mode !== (isFocusMode ? 'focus' : 'break')) {
                // Manually switch mode without triggering the button logic again
                isFocusMode = (data.mode === 'focus');
                timeLeft = data.timeLeft;
                statusLabel.innerText = isFocusMode ? "Focus" : "Rest";
                modeBtn.innerText = isFocusMode ? "Take Break" : "Back to Work";
                resetButtonStyle();
                updateDisplay();
            }
        }
    });
    
    // Stop everything if someone closes the tab
    roomRef.onDisconnect().update({ isRunning: false });
    
            function toggleTimer() {
        // We only update the DB. The listener handles the actual starting/stopping.
        roomRef.update({
            isRunning: !isRunning
        });
    }


        function unlockAudio() {
            if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
            if (audioCtx.state === 'suspended') { audioCtx.resume(); }
            if(alarmAudio.src) { alarmAudio.play().then(() => alarmAudio.pause()).catch(() => {}); }
        }

        function startTimer() {
            unlockAudio();
            if (!alarmAudio.src) { alarmAudio.src = silentAudioData; }
            alarmAudio.volume = 0.01; 
            alarmAudio.loop = true;
            alarmAudio.play().catch(() => {});

            if (timeLeft <= 0) return;

            isRunning = true;
            startBtn.innerText = "Pause";
            startBtn.style.background = "#F59E0B"; 
            
            const endTime = Date.now() + (timeLeft * 1000);
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const now = Date.now();
                const secondsRemaining = Math.ceil((endTime - now) / 1000);
                if (secondsRemaining > 0) {
                    timeLeft = secondsRemaining;
                    updateDisplay();
                } else {
                    timeLeft = 0;
                    updateDisplay();
                    completeTimer();
                }
            }, 1000);
        }

        function pauseTimer() {
            isRunning = false;
            startBtn.innerText = isFocusMode ? "Resume Focus" : "Resume Break";
            resetButtonStyle();
            clearInterval(timerInterval);
        }

        function resetButtonStyle() {
            const color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
            startBtn.style.background = color;
        }

            function switchMode() {
        const newMode = !isFocusMode;
        const newTime = newMode ? 25 * 60 : 5 * 60;
        
        // Send new mode to DB
        roomRef.update({
            mode: newMode ? 'focus' : 'break',
            timeLeft: newTime,
            isRunning: false
        });
    }


        function updateDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            timeDisplay.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            drawRing(timeLeft / maxSeconds);
        }

        alarmInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileURL = URL.createObjectURL(file);
                alarmAudio.src = fileURL;
                fileNameDisplay.innerText = "Selected: " + file.name.substring(0, 15) + "...";
            }
        });

                function playDefaultBeep() {
            if (!audioCtx) unlockAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            osc.frequency.setValueAtTime(440, audioCtx.currentTime + 0.5);
            osc.type = 'sine';
            osc.start();
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + 1);
        }

        function completeTimer() {
            // --- FIX: This line is now inside the function so it doesn't crash the page ---
            saveSession(25); 
            // --------------------------------------------------------------------------

            clearInterval(timerInterval);
            isRunning = false;
            
            alarmAudio.loop = true;
            alarmAudio.volume = 1.0;
            
            if (alarmAudio.src === silentAudioData) {
                alarmAudio.pause();
                playDefaultBeep();
                window.beepInterval = setInterval(playDefaultBeep, 1500);
            } else {
                alarmAudio.currentTime = 0;
                alarmAudio.play();
            }
            alarmModal.style.display = "flex";
            startBtn.innerText = isFocusMode ? "Resume Focus" : "Resume Break";
            resetButtonStyle();
        }

        function completeTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            
            alarmAudio.loop = true;
            alarmAudio.volume = 1.0;
            
            if (alarmAudio.src === silentAudioData) {
                alarmAudio.pause();
                playDefaultBeep();
                window.beepInterval = setInterval(playDefaultBeep, 1500);
            } else {
                alarmAudio.currentTime = 0;
                alarmAudio.play();
            }
            alarmModal.style.display = "flex";
            startBtn.innerText = isFocusMode ? "Resume Focus" : "Resume Break";
            resetButtonStyle();
        }

        function stopAlarm() {
            if (alarmAudio.src) { alarmAudio.pause(); alarmAudio.currentTime = 0; }
            if (window.beepInterval) { clearInterval(window.beepInterval); }
            alarmModal.style.display = "none";
            switchMode();
        }

        let tasks = JSON.parse(localStorage.getItem('proFlowTasks')) || [];
        const taskInput = document.getElementById('taskInput');
        const taskList = document.getElementById('taskList');
        renderTasks();

        function handleEnter(e) { if (e.key === 'Enter') addTask(); }
        function addTask() {
            if (taskInput.value.trim()) {
                tasks.push({ text: taskInput.value.trim(), done: false });
                taskInput.value = '';
                saveTasks();
                renderTasks();
            }
        }
        function toggleTask(i) { tasks[i].done = !tasks[i].done; saveTasks(); renderTasks(); }
        function deleteTask(i) { tasks.splice(i, 1); saveTasks(); renderTasks(); }
        function saveTasks() { localStorage.setItem('proFlowTasks', JSON.stringify(tasks)); }
        function renderTasks() {
            taskList.innerHTML = '';
            tasks.forEach((t, i) => {
                taskList.innerHTML += `<li class="${t.done?'done':''}"><div class="custom-checkbox" onclick="toggleTask(${i})"></div><span style="flex:1" onclick="toggleTask(${i})">${t.text}</span><button class="delete-btn" onclick="deleteTask(${i})">‚úï</button></li>`;
            });
        }
        function copyLink() {
    const link = window.location.href;
    navigator.clipboard.writeText(link).then(() => {
        alert("Link copied! Send this to your friend: \n" + link);
    });
}

                // --- STATS LOGIC ---
        
        // 1. Load History
        let focusHistory = JSON.parse(localStorage.getItem('focusStats')) || {};

        // 2. Function to Save a Completed Session
        function saveSession(minutes) {
            const today = new Date().toISOString().split('T')[0]; // "2023-10-27"
            
            if (!focusHistory[today]) focusHistory[today] = 0;
            focusHistory[today] += minutes;
            
            localStorage.setItem('focusStats', JSON.stringify(focusHistory));
            renderStats(); // Update chart
        }

        // 3. Function to Draw the Chart
        function renderStats() {
            const chartContainer = document.getElementById('weeklyChart');
            chartContainer.innerHTML = '';
            
            // Get last 7 days
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateKey = d.toISOString().split('T')[0];
                const minutes = focusHistory[dateKey] || 0;
                const dayName = days[d.getDay()];
                
                // Max height 80px for 2 hours (120 mins)
                let height = Math.min((minutes / 120) * 80, 80);
                // Min height 4px if there is any data
                if (minutes > 0 && height < 4) height = 4;
                
                chartContainer.innerHTML += `
                    <div class="chart-bar-wrapper">
                        <div class="chart-bar" style="height: ${height}px;"></div>
                        <div class="chart-day">${dayName}</div>
                    </div>
                `;
            }
        }

        // Initialize Stats on Load
        renderStats();
        
    </script>
</body>

</html> 
